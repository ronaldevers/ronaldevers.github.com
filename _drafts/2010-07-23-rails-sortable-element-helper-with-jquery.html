---
title: 
layout: post
---

'2010-07-23 07:54:42','Ryan Bates of <a href=\"http://railscasts.com\">railscasts.com</a> has an <a href=\"http://railscasts.com/episodes/147-sortable-lists\">excellent screencast on sortable lists</a>. In this post I will show that it is easy to extend the prototype approach from the screencast to nested lists or trees and I will show you how to do a jQuery alternative.\r\n<h2>Prototype / Scriptaculous</h2>\r\nRyan uses the <code>sortable_element</code> Rails scriptaculous helper. If we look at <a href=\"http://api.rubyonrails.org/classes/ActionView/Helpers/ScriptaculousHelper.html#M001640\">the api documentation for this helper</a>, we can see that it has a <code>:tree</code> option. If we add this option the call to sortable_element becomes simply:\r\n<pre><code>&lt;%= sortable_element(\"faqs\", :url =&gt; sort_faqs_path, :handle =&gt; \"handle\", :tree =&gt; true) %&gt;\r\n</code></pre>\r\nNow we need to update the server side code as well. This is relatively easily handled with a recursive method over all children etc. but I will leave this as an exercise to the reader and instead continue with the jQuery alternative.\r\n\r\n<!--more-->\r\n\r\n<h2>jQuery / jsTree</h2>\r\nWith the <code>sortable_element</code> helper you cannot create a new nesting level by dragging a node onto or underneath another node. This is a major shortcoming for me. I have found an alternative that does the trick for me in <a href=\"http://jstree.com\">jsTree</a>. I will use the <a href=\"http://code.google.com/p/jquery-json/\"><code>jquery.json</code> plugin</a> to serialize the tree data.\r\n\r\nAdd the <code>jquery.jstree.min.js</code> and <code>jquery.json.min.js</code> javascript files to your <code>javascript_include_tag</code> and stick the following in your<code>application.js</code> or wherever you want.\r\n<pre>function setup_tree(options) {\r\n  $(options.selector).tree({\r\n    types : {\r\n      \"default\" : {\r\n        clickable  : true,\r\n        renameable : false,\r\n        deletable  : false,\r\n        creatable  : false,\r\n        draggable  : options.draggable\r\n      }\r\n    },\r\n    callback : {\r\n      onchange : function(NODE,TREE_OBJ) {\r\n        // http://www.jstree.com/faq (see faq 4 on links in predefined html)\r\n        document.location = $(NODE).children(\"a:eq(0)\").attr(\"href\");\r\n      },\r\n      onmove : function(NODE,REF_NODE,TYPE,TREE_OBJ,RB) {\r\n        // might need to use rails\' authenticity_token?\r\n        $.ajax({\r\n            url: options.post_url,\r\n            type: \'POST\',\r\n            data: $.toJSON(TREE_OBJ.get(null, \'json\')),\r\n            contentType: \'application/json; charset=utf-8\',\r\n        });\r\n      }\r\n    }\r\n  });\r\n}</pre>\r\nThis sets up a function named <code>setup_tree</code> which you can call with a dictionary argument as follows:\r\n<pre>$(function() { setup_tree({ selector: \'#sitemap\', post_url: \'/pages/sort\', draggable: true}); } );</pre>\r\nDon\'t forget to add the images and css from the jstree package to your public folder. That\'s basically it! All you need now is server side code to process the new ordering.\r\n\r\nroutes.rb:\r\n<pre>  map.resources :pages, :collection =&gt; { :sort =&gt; :post }</pre>\r\npages_controller.rb:\r\n\r\nNote that the first line with <code>unauthorized! if...</code> is because I am using <a href=\"http://github.com/ryanb/cancan\">cancan</a>.\r\n<pre>class PagesController &lt; ApplicationController\r\n\r\n  ...\r\n\r\n  def sort\r\n    unauthorized! if cannot? :manage, Page\r\n    Page.order params[\'_json\']\r\n    render :nothing =&gt; true\r\n  end\r\n\r\nend</pre>\r\npage.rb:\r\n\r\nNote that I am first nullifying the position column on all pages because I have a unique index setup on the column. See also <a href=\"http://henrik.nyh.se/2008/11/rails-jquery-sortables\">Henrik Nye\'s blog</a> for ideas on how to apply the new ordering with just one query (although not for trees but just lists).\r\n<pre>class Page &lt; ActiveRecord::Base\r\n  def self.order json\r\n    Page.update_all([\'position = ?\', nil])\r\n    Page.order_helper json\r\n  end\r\n\r\n  private\r\n  def self.order_helper json, position = 0, parent_id = nil\r\n    json.each do |hash|\r\n      page_id = hash[\'attributes\'][\'id\'].delete(\'page_\')\r\n      Page.update_all([\'position = ?, parent_id = ?\', position, parent_id], [\'id = ?\', page_id])\r\n      position += 1\r\n      if hash[\'children\']\r\n        # doe hetzelfde recursief\r\n        position = order_helper hash[\'children\'], position, page_id\r\n      end\r\n    end\r\n    position\r\n  end \r\n\r\nend</pre>','Rails sortable_element helper with jQuery','','publish','open','open','','rails-sortable_element-helper-with-jquery','','','2010-07-26 18:21:26','2010-07-26 16:21:26','',0,'http://blog.ronaldevers.nl/?p=17',0,'post','',0);
